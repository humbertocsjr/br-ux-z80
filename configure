#!/bin/sh

check_cmd() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
    else
        if [ -z "`command -v $2`" ]; then 
            echo "\033[0;31m$2 is missing\033[0m"
            rm build/conf.mk include/osver.*
            exit 1
        fi
        echo "`command -v $2`"
        echo "$1=`command -v $2`" >> build/conf.mk
    fi
}

check_var() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
    else
        echo "$2"
        echo "$1=$2" >> build/conf.mk
    fi
}

check_txt() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
    else
        if [ -z "`cat $2`" ]; then 
            echo "\033[0;31m$2 is missing\033[0m"
            rm build/conf.mk include/osver.*
            exit 1
        fi
        echo "`cat $2`"
        echo "$1=`cat $2`" >> build/conf.mk
    fi
}

check_ver() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
        echo "#define $1 $3" >> include/osver.h
        echo "$1 equ $3" >> include/osver.s
    else
        if [ -z "`cat $2`" ]; then 
            echo "\033[0;31m$2 is missing\033[0m"
            rm build/conf.mk include/osver.*
            exit 1
        fi
        echo "`cat $2`"
        echo "$1=`cat $2`" >> build/conf.mk
        echo "#define $1 `cat $2`" >> include/osver.h
        echo "$1: equ `cat $2`" >> include/osver.s
    fi
}

check_vch() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
        echo "#define $1 '$3'" >> include/osver.h
        echo "$1 equ '$3'" >> include/osver.s
    else
        if [ -z "`cat $2`" ]; then 
            echo "\033[0;31m$2 is missing\033[0m"
            rm build/conf.mk include/osver.*
            exit 1
        fi
        echo "`cat $2`"
        echo "$1=`cat $2`" >> build/conf.mk
        echo "#define $1 '`cat $2`'" >> include/osver.h
        echo "$1: equ '`cat $2`'" >> include/osver.s
    fi
}

check_vhx() {
    echo -n "$1 = "
    if [ "$3" ]; then
        echo "$3"
        echo "$1=$3" >> build/conf.mk
        echo "#define $1 0x$3" >> include/osver.h
        echo "$1 equ 0x$3" >> include/osver.s
    else
        if [ -z "`cat $2`" ]; then 
            echo "\033[0;31m$2 is missing\033[0m"
            rm build/conf.mk include/osver.*
            exit 1
        fi
        echo "`cat $2`"
        echo "$1=`cat $2`" >> build/conf.mk
        echo "#define $1 0x`cat $2`" >> include/osver.h
        echo "$1: equ 0x`cat $2`" >> include/osver.s
    fi
}

mkdir -p include
mkdir -p output

echo "#Generated by configure" > build/conf.mk
echo "//Generated by configure" > include/osver.h
echo ";Generated by configure" > include/osver.s

check_var "ASZ80" "`pwd`/bin/gasm80" "$ASZ80"
check_cmd "CC" "cc" "$CC"
check_var "CFLAGS" "-c " "$CFLAGS"
check_var "CCFLAGS" " " "$CCFLAGS"
check_var "MAKE" "make --no-print-directory" "$MAKE"
check_ver "VERSION" "build/version" "$VERSION"
check_vch "EDITION" "build/edition" "$EDITION"
check_ver "SUB_VERSION" "build/sub_version" "$SUB_VERSION"
check_vhx "REVISION" "build/revision" "$REVISION"
echo "" >> build/conf.mk
cat build/base.mk >> build/conf.mk
